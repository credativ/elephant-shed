# queries run once per cluster (via the 'postgres' database)

- name: "running_queries"
  help: "number of running queries"
  scope: cluster
  labels:
    - "datname"
    - "usename"
  values:
    - "count"
  query: >-
          SELECT datname::text, usename::text, COUNT(*)::float AS count
          FROM pg_stat_activity
          WHERE NOT datname ~ '^template(0|1)$'
          GROUP BY datname, usename

- name: "pg_stat_activity"
  help: "running backends by database and state"
  scope: cluster
  labels:
    - "datname"
    - "state"
  values:
    - "count"
    - "max_tx_duration"
  query: >-
          SELECT
                  pg_database.datname::text,
                  tmp.state::text,
                  COALESCE(count, 0) as count,
                  COALESCE(max_tx_duration, 0) as max_tx_duration
          FROM
                  (
                    VALUES ('active'),
                                   ('idle'),
                                   ('idle in transaction'),
                                   ('idle in transaction (aborted)'),
                                   ('fastpath function call'),
                                   ('disabled')
                  ) AS tmp(state) CROSS JOIN pg_database
          LEFT JOIN
          (
                  SELECT
                          datname,
                          state,
                          count(*) AS count,
                          MAX(EXTRACT(EPOCH FROM now() - xact_start))::float AS max_tx_duration
                  FROM pg_stat_activity
                  GROUP BY datname, state) AS tmp2
                  ON tmp.state = tmp2.state AND pg_database.datname = tmp2.datname
          WHERE NOT pg_database.datname ~ '^template(0|1)$'
